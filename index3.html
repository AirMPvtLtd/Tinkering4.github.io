<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AiRM Fateh Drone Programming Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.0/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f0ff;
            --secondary: #ff3e7f;
            --dark: #0a0a1a;
            --darker: #050510;
        }
        
        body {
            background: var(--dark);
            font-family: 'Ubuntu Mono', monospace;
            color: #e0e0ff;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .editor-font {
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
        }
        
        .interface-font {
            font-family: 'Ubuntu Mono', monospace;
        }
        
        .cyber-card {
            background: rgba(10, 10, 26, 0.9);
            border: 1px solid var(--primary);
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .cyber-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .cyber-button {
            background: rgba(0, 240, 255, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 6px 12px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cyber-button:hover {
            background: rgba(0, 240, 255, 0.2);
            box-shadow: 0 0 8px var(--primary);
        }
        
        .delete-button {
            background: rgba(255, 62, 127, 0.1);
            color: var(--secondary);
            border: 1px solid var(--secondary);
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .delete-button:hover {
            background: rgba(255, 62, 127, 0.2);
            box-shadow: 0 0 8px var(--secondary);
        }
        
        .add-button {
            background: rgba(0, 255, 128, 0.1);
            color: #00ff80;
            border: 1px solid #00ff80;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .add-button:hover {
            background: rgba(0, 255, 128, 0.2);
            box-shadow: 0 0 8px #00ff80;
        }
        
        .status-active {
            background: var(--primary);
            box-shadow: 0 0 8px var(--primary);
        }
        
        .hologram-container {
            width: 100%;
            height: 300px;
            position: relative;
        }
        
        .scrollable-container {
            overflow-y: auto;
            max-height: calc(100vh - 200px);
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--dark);
        }
        
        .scrollable-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-container::-webkit-scrollbar-track {
            background: var(--dark);
        }
        
        .scrollable-container::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 3px;
        }
        
        @media (max-height: 800px) {
            .scrollable-container {
                max-height: calc(100vh - 150px);
            }
        }
        
        .tab-active {
            background: rgba(0, 240, 255, 0.2);
            box-shadow: 0 0 8px var(--primary);
        }
        
        .completed-badge {
            background: rgba(0, 255, 128, 0.2);
            color: #00ff80;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .dynamic-height {
            height: calc(100vh - 180px);
            min-height: 500px;
        }

        .input-field {
            background: rgba(0, 0, 0, 0.8);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 4px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            box-shadow: 0 0 8px var(--primary);
        }

        .progress-bar {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--primary);
            border-radius: 4px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: var(--primary);
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen"></div>

    <script type="text/babel">
        function App() {
            const [status, setStatus] = React.useState('Initializing...');
            const [isSimulating, setIsSimulating] = React.useState(false);
            const [angles, setAngles] = React.useState([0, 0, 0]);
            const [height, setHeight] = React.useState(0);
            const [simulationError, setSimulationError] = React.useState(null);
            const [activeTab, setActiveTab] = React.useState('FATEH-V1');
            const [editorContent, setEditorContent] = React.useState('');
            const [logicInput, setLogicInput] = React.useState('');
            const [buildOutput, setBuildOutput] = React.useState('');
            const [challenges, setChallenges] = React.useState([
                {
                    id: 1,
                    title: 'STABLE HOVER',
                    description: 'Maintain 1m altitude for 30 seconds',
                    points: 100,
                    criteria: { height: 1, rollMax: 5, pitchMax: 5, duration: 30 }
                },
                {
                    id: 2,
                    title: 'PRECISE ASCENT',
                    description: 'Reach 2m altitude in 10 seconds',
                    points: 150,
                    criteria: { height: 2, rollMax: 10, pitchMax: 10, duration: 10 }
                },
                {
                    id: 3,
                    title: 'SOFT LANDING',
                    description: 'Land from 1m altitude smoothly',
                    points: 200,
                    criteria: { height: 0, rollMax: 3, pitchMax: 3, duration: 15 }
                }
            ]);
            const [userProgress, setUserProgress] = React.useState({});
            const [leaderboard, setLeaderboard] = React.useState([]);
            const [username, setUsername] = React.useState('');
            const [showProfileModal, setShowProfileModal] = React.useState(false);
            const [selectedProfiles, setSelectedProfiles] = React.useState([]);
            const [showDeleteConfirm, setShowDeleteConfirm] = React.useState(false);
            const [currentIp, setCurrentIp] = React.useState('');
            const [droneConfig, setDroneConfig] = React.useState({
                ip: '192.168.4.1',
                port: 8080,
                ssid: 'PicoW',
                password: 'pico1234'
            });
            const [isDeploying, setIsDeploying] = React.useState(false);
            const [connectionStatus, setConnectionStatus] = React.useState('Not connected');
            const [deployProgress, setDeployProgress] = React.useState(0);

            const containerRef = React.useRef(null);
            const sceneRef = React.useRef(null);
            const cameraRef = React.useRef(null);
            const rendererRef = React.useRef(null);
            const droneGroupRef = React.useRef(null);
            const editorRef = React.useRef(null);

            // Simulate IP address for the session
            React.useEffect(() => {
                const generateRandomIp = () => {
                    return `${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}`;
                };
                setCurrentIp(generateRandomIp());
                // Load drone config from localStorage
                const savedConfig = localStorage.getItem('droneConfig');
                if (savedConfig) {
                    setDroneConfig(JSON.parse(savedConfig));
                }
            }, []);

            const codeTemplates = {
                'FATEH-V1': `# FATEH V1 DEFAULT CONTROL SYSTEM
def mode(pids, throttle, angles, targets, dt):
    motor_speed = 65535 * (throttle / 100)
    return (motor_speed, motor_speed, motor_speed, motor_speed)`,
                
                'CUSTOM': `# CUSTOM DRONE CONTROL FUNCTION
def mode(pids, throttle, angles, targets, dt):
    kp = 1.0
    ki = 0.05
    kd = 0.2
    pids[0].set_gains(kp, ki, kd)
    pids[1].set_gains(kp, ki, kd)
    pids[2].set_gains(kp/2, ki, kd)
    base = max(throttle * 65535 * 0.5 / 100, 65535 * 0.25)
    roll_corr = pids[0].update(targets[0], angles[0], dt)
    pitch_corr = pids[1].update(targets[1], angles[1], dt)
    yaw_corr = pids[2].update(targets[2], angles[2], dt)
    return (
        base + pitch_corr + roll_corr + yaw_corr,
        base + pitch_corr - roll_corr - yaw_corr,
        base - pitch_corr + roll_corr - yaw_corr,
        base - pitch_corr - roll_corr + yaw_corr
    )`,
                
                'CHALLENGES': `# CHALLENGE MODE TEMPLATE
def mode(pids, throttle, angles, targets, dt):
    kp = 1.0
    ki = 0.05
    kd = 0.2
    pids[0].set_gains(kp, ki, kd)
    pids[1].set_gains(kp, ki, kd)
    pids[2].set_gains(kp/2, ki, kd)
    base = max(throttle * 65535 * 0.5 / 100, 65535 * 0.25)
    roll_corr = pids[0].update(0, angles[0], dt)
    pitch_corr = pids[1].update(0, angles[1], dt)
    yaw_corr = pids[2].update(0, angles[2], dt)
    return (
        base + pitch_corr + roll_corr + yaw_corr,
        base + pitch_corr - roll_corr - yaw_corr,
        base - pitch_corr + roll_corr - yaw_corr,
        base - pitch_corr - roll_corr + yaw_corr
    )`
            };

            React.useEffect(() => {
                const initializeEditor = async () => {
                    try {
                        window.require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' } });
                        window.require(['vs/editor/editor.main'], () => {
                            if (editorRef.current) editorRef.current.dispose();
                            
                            editorRef.current = monaco.editor.create(document.getElementById('editor'), {
                                value: codeTemplates[activeTab],
                                language: 'python',
                                theme: 'vs-dark',
                                fontFamily: 'Share Tech Mono',
                                fontSize: 14,
                                minimap: { enabled: false },
                                scrollBeyondLastLine: false,
                                automaticLayout: true
                            });
                            
                            editorRef.current.onDidChangeModelContent(() => {
                                setEditorContent(editorRef.current.getValue());
                            });
                            
                            setStatus('Ready');
                        });
                    } catch (error) {
                        console.error('Editor Initialization Error:', error);
                        setStatus('Editor initialization failed');
                    }
                };
                
                initializeEditor();
                
                return () => {
                    if (editorRef.current) {
                        editorRef.current.dispose();
                    }
                };
            }, [activeTab]);

            React.useEffect(() => {
                if (!containerRef.current) {
                    setSimulationError('Container element not found');
                    return;
                }

                let animationFrameId;
                try {
                    if (!window.THREE) {
                        throw new Error('Three.js library not loaded');
                    }

                    if (!WebGLRenderingContext || !document.createElement('canvas').getContext('webgl')) {
                        throw new Error('WebGL not supported by this browser');
                    }

                    const scene = new THREE.Scene();
                    scene.background = null;
                    sceneRef.current = scene;
                    
                    const camera = new THREE.PerspectiveCamera(
                        75, 
                        containerRef.current.clientWidth / 300, 
                        0.1, 
                        1000
                    );
                    camera.position.set(0, 2, 5);
                    camera.lookAt(0, 0, 0);
                    cameraRef.current = camera;
                    
                    const renderer = new THREE.WebGLRenderer({ 
                        antialias: true, 
                        alpha: true 
                    });
                    renderer.setSize(
                        containerRef.current.clientWidth, 
                        300
                    );
                    containerRef.current.appendChild(renderer.domElement);
                    rendererRef.current = renderer;
                    
                    const droneGroup = new THREE.Group();
                    
                    const bodyGeometry = new THREE.BoxGeometry(0.5, 0.2, 0.5);
                    const bodyMaterial = new THREE.MeshBasicMaterial({ 
                        color: 0x00f0ff,
                        wireframe: true
                    });
                    const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                    droneGroup.add(body);
                    
                    const armGeometry = new THREE.BoxGeometry(0.8, 0.05, 0.05);
                    const armMaterial = new THREE.MeshBasicMaterial({ 
                        color: 0xff3e7f,
                        wireframe: true
                    });
                    
                    for (let i = 0; i < 4; i++) {
                        const arm = new THREE.Mesh(armGeometry, armMaterial);
                        arm.position.set(
                            0.5 * Math.cos((i * Math.PI) / 2),
                            0,
                            0.5 * Math.sin((i * Math.PI) / 2)
                        );
                        arm.rotation.y = (i * Math.PI) / 2;
                        droneGroup.add(arm);
                    }
                    
                    const propGeometry = new THREE.CylinderGeometry(0.2, 0.2, 0.02, 16);
                    const propMaterial = new THREE.MeshBasicMaterial({ 
                        color: 0x00ff88,
                        wireframe: true
                    });
                    
                    for (let i = 0; i < 4; i++) {
                        const prop = new THREE.Mesh(propGeometry, propMaterial);
                        prop.position.set(
                            0.7 * Math.cos((i * Math.PI) / 2),
                            0.1,
                            0.7 * Math.sin((i * Math.PI) / 2)
                        );
                        droneGroup.add(prop);
                    }
                    
                    scene.add(droneGroup);
                    droneGroupRef.current = droneGroup;
                    
                    const ambientLight = new THREE.AmbientLight(0x404040);
                    scene.add(ambientLight);
                    
                    const pointLight = new THREE.PointLight(0x00f0ff, 1, 100);
                    pointLight.position.set(5, 5, 5);
                    scene.add(pointLight);
                    
                    const animate = () => {
                        try {
                            if (isSimulating && droneGroupRef.current) {
                                droneGroupRef.current.rotation.x = angles[1] * (Math.PI / 180);
                                droneGroupRef.current.rotation.z = -angles[0] * (Math.PI / 180);
                                droneGroupRef.current.rotation.y = angles[2] * (Math.PI / 180);
                                droneGroupRef.current.position.y = height * 0.1;
                                
                                droneGroupRef.current.children.forEach((child, index) => {
                                    if (index >= 5) {
                                        child.rotation.z += 0.1;
                                    }
                                });
                            }
                            
                            if (rendererRef.current && sceneRef.current && cameraRef.current) {
                                rendererRef.current.render(sceneRef.current, cameraRef.current);
                            }
                            animationFrameId = requestAnimationFrame(animate);
                        } catch (error) {
                            console.error('Animation Error:', error);
                            setSimulationError('Animation rendering failed: ' + error.message);
                            cancelAnimationFrame(animationFrameId);
                        }
                    };
                    
                    animate();
                    setSimulationError(null);
                    
                    const handleResize = () => {
                        try {
                            if (containerRef.current && cameraRef.current && rendererRef.current) {
                                cameraRef.current.aspect = containerRef.current.clientWidth / 300;
                                cameraRef.current.updateProjectionMatrix();
                                rendererRef.current.setSize(
                                    containerRef.current.clientWidth, 
                                    300
                                );
                            }
                        } catch (error) {
                            console.error('Resize Error:', error);
                            setSimulationError('Window resize handling failed: ' + error.message);
                        }
                    };
                    
                    window.addEventListener('resize', handleResize);
                    
                    return () => {
                        try {
                            cancelAnimationFrame(animationFrameId);
                            window.removeEventListener('resize', handleResize);
                            if (rendererRef.current) {
                                rendererRef.current.dispose();
                            }
                            if (containerRef.current && rendererRef.current?.domElement) {
                                containerRef.current.removeChild(rendererRef.current.domElement);
                            }
                        } catch (error) {
                            console.error('Cleanup Error:', error);
                            setSimulationError('Simulation cleanup failed: ' + error.message);
                        }
                    };
                } catch (error) {
                    console.error('3D Initialization Error:', error);
                    setSimulationError('Failed to initialize 3D simulation: ' + error.message);
                }
            }, [isSimulating, angles, height]);

            // Test drone connection
            const testDroneConnection = async () => {
                setConnectionStatus('Testing connection...');
                try {
                    // Attempt a simple HTTP GET or WebSocket connection
                    const response = await fetch(`http://${droneConfig.ip}:${droneConfig.port}/ping`, {
                        method: 'GET',
                        timeout: 2000
                    });
                    if (response.ok) {
                        setConnectionStatus('Connected');
                        setStatus('Drone connection successful');
                    } else {
                        setConnectionStatus('Connection failed');
                        setStatus('Failed to connect to drone');
                    }
                } catch (error) {
                    console.error('Connection Test Error:', error);
                    setConnectionStatus('Connection failed');
                    setStatus(`Failed to connect to drone: ${error.message}`);
                }
            };

            // Save drone config to localStorage
            const saveDroneConfig = (newConfig) => {
                setDroneConfig(newConfig);
                localStorage.setItem('droneConfig', JSON.stringify(newConfig));
            };

            const handleCreateProfile = () => {
                if (!username.trim()) {
                    setStatus('Please enter a username');
                    return;
                }
                if (username.length > 15) {
                    setStatus('Username must be 15 characters or less');
                    return;
                }
                if (leaderboard.some(entry => entry.name === username)) {
                    setStatus('Username already exists');
                    return;
                }
                
                setLeaderboard(prev => [
                    ...prev,
                    { name: username, score: 0, owner: username, ip: currentIp }
                ]);
                setShowProfileModal(false);
                setStatus('Profile created');
            };

            const handleAddProfile = () => {
                setShowProfileModal(true);
                setUsername('');
            };

            const handleCheckboxChange = (name) => {
                setSelectedProfiles(prev => 
                    prev.includes(name)
                        ? prev.filter(n => n !== name)
                        : [...prev, name]
                );
            };

            const handleDeleteProfile = () => {
                if (selectedProfiles.length === 0) {
                    setStatus('Please select at least one profile to delete');
                    return;
                }
                
                const invalidSelections = selectedProfiles.filter(name => {
                    const entry = leaderboard.find(entry => entry.name === name);
                    return entry && entry.ip !== currentIp;
                });

                if (invalidSelections.length > 0) {
                    setStatus('You can only delete profiles created from your IP');
                    return;
                }

                setShowDeleteConfirm(true);
            };

            const confirmDelete = () => {
                setLeaderboard(prev => prev.filter(entry => !selectedProfiles.includes(entry.name)));
                setSelectedProfiles([]);
                setShowDeleteConfirm(false);
                setStatus('Profile(s) deleted');
                setUsername('');
            };

            const cancelDelete = () => {
                setShowDeleteConfirm(false);
                setStatus('Deletion cancelled');
            };

            const handleControl = (command) => {
                const step = 1;
                let newAngles = [...angles];
                let newHeight = height;
                
                switch (command) {
                    case 'Up': newHeight = Math.min(newHeight + step, 100); break;
                    case 'Down': newHeight = Math.max(newHeight - step, 0); break;
                    case 'Forward': newAngles[1] = Math.min(newAngles[1] + step, 45); break;
                    case 'Backward': newAngles[1] = Math.max(newAngles[1] - step, -45); break;
                    case 'Left': newAngles[0] = Math.max(newAngles[0] - step, -45); break;
                    case 'Right': newAngles[0] = Math.min(newAngles[0] + step, 45); break;
                    case 'Yaw Left': newAngles[2] = (newAngles[2] - step) % 360; break;
                    case 'Yaw Right': newAngles[2] = (newAngles[2] + step) % 360; break;
                    case 'Reset': 
                        newAngles = [0, 0, 0];
                        newHeight = 0;
                        break;
                }
                
                setAngles(newAngles);
                setHeight(newHeight);
            };

            const buildCode = () => {
                setStatus('Building...');
                setBuildOutput('');
                
                setTimeout(() => {
                    try {
                        if (!editorContent.includes('def mode(')) {
                            throw new Error('Missing mode() function');
                        }
                        
                        setBuildOutput('Build successful!\nCode validated and ready for simulation');
                        setStatus('Ready');
                    } catch (error) {
                        setBuildOutput(`Build failed: ${error.message}`);
                        setStatus('Build error');
                    }
                }, 1000);
            };

            const startSimulation = () => {
                if (buildOutput.includes('failed')) {
                    setStatus('Fix build errors first');
                    return;
                }
                
                setStatus('Starting simulation...');
                setIsSimulating(true);
                
                setTimeout(() => {
                    setStatus('Simulation running');
                }, 500);
            };

            const deployToDrone = async () => {
                if (isDeploying) {
                    setStatus('Deployment already in progress');
                    return;
                }
                if (!buildOutput.includes('successful')) {
                    setStatus('Code not built successfully');
                    return;
                }
                if (editorContent.length > 10000) {
                    setStatus('Code size exceeds drone memory limit');
                    return;
                }

                setIsDeploying(true);
                setDeployProgress(0);
                setStatus('Connecting to drone...');

                let ws;
                try {
                    // Establish WebSocket connection
                    ws = new WebSocket(`ws://${droneConfig.ip}:${droneConfig.port}`);
                    
                    ws.onopen = () => {
                        setStatus('Sending deploy command...');
                        ws.send('deploy_code\n');
                    };

                    ws.onmessage = async (event) => {
                        const message = event.data.trim();
                        console.log('Received from drone:', message);

                        if (message === 'ack: deploy_ready') {
                            setStatus('Sending code...');
                            // Send code in chunks
                            const chunkSize = 128;
                            const code = editorContent + '\nEOF\n';
                            const totalBytes = code.length;
                            let bytesSent = 0;

                            while (bytesSent < totalBytes) {
                                const chunk = code.slice(bytesSent, bytesSent + chunkSize);
                                ws.send(chunk);
                                bytesSent += chunk.length;
                                setDeployProgress(Math.min((bytesSent / totalBytes) * 100, 100));
                                await new Promise(resolve => setTimeout(resolve, 10)); // Small delay to avoid overwhelming drone
                            }
                        } else if (message === 'ack: code_received') {
                            setStatus('Deployment successful');
                            ws.send('ping\n'); // Confirm drone is still responsive
                        } else if (message.startsWith('error:')) {
                            setStatus(`Deployment failed: ${message}`);
                            ws.close();
                        } else if (message === 'pong') {
                            setStatus('Deployment successful, drone responsive');
                            ws.close();
                        }
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocket Error:', error);
                        setStatus('Deployment failed: Connection error');
                        setIsDeploying(false);
                        setDeployProgress(0);
                    };

                    ws.onclose = () => {
                        setIsDeploying(false);
                        setDeployProgress(0);
                        if (status !== 'Deployment successful' && status !== 'Deployment successful, drone responsive') {
                            setStatus('Deployment failed: Connection closed');
                        }
                    };

                    // Timeout for WebSocket connection
                    setTimeout(() => {
                        if (ws.readyState !== WebSocket.OPEN && ws.readyState !== WebSocket.CLOSED) {
                            ws.close();
                            setStatus('Deployment failed: Connection timeout');
                            setIsDeploying(false);
                            setDeployProgress(0);
                        }
                    }, 5000);

                } catch (error) {
                    console.error('Deployment Error:', error);
                    setStatus(`Deployment failed: ${error.message}`);
                    setIsDeploying(false);
                    setDeployProgress(0);
                    if (ws) ws.close();
                }
            };

            const convertLogic = () => {
                if (!logicInput.trim()) {
                    setStatus('Enter logic first');
                    return;
                }
                
                setStatus('Converting logic...');
                
                try {
                    let convertedCode = '';
                    const input = logicInput.toLowerCase();
                    
                    if (input.includes('if height >')) {
                        const value = logicInput.match(/height > (\d+)/)?.[1] || '1';
                        const action = input.includes('increase') ? '+' : '-';
                        const amount = logicInput.match(/(\d+)/)?.[1] || '10';
                        convertedCode = `if height > ${value}:\n    # Adjust throttle\n    throttle = throttle ${action} ${amount}`;
                    } 
                    else if (input.includes('if height <')) {
                        const value = logicInput.match(/height < (\d+)/)?.[1] || '1';
                        const action = input.includes('increase') ? '+' : '-';
                        const amount = logicInput.match(/(\d+)/)?.[1] || '10';
                        convertedCode = `if height < ${value}:\n    # Adjust throttle\n    throttle = throttle ${action} ${amount}`;
                    }
                    else if (input.includes('if roll >')) {
                        const value = logicInput.match(/roll > (\d+)/)?.[1] || '5';
                        const correction = input.includes('left') ? '-' : '+';
                        convertedCode = `if angles[0] > ${value}:\n    # Correct roll\n    roll_corr = roll_corr ${correction} 100`;
                    }
                    else if (input.includes('if pitch >')) {
                        const value = logicInput.match(/pitch > (\d+)/)?.[1] || '5';
                        const correction = input.includes('forward') ? '-' : '+';
                        convertedCode = `if angles[1] > ${value}:\n    # Correct pitch\n    pitch_corr = pitch_corr ${correction} 100`;
                    }
                    else if (input.includes('after') && input.includes('seconds')) {
                        const seconds = logicInput.match(/(\d+)\s*seconds/)?.[1] || '5';
                        const action = input.includes('increase') ? '+' : '-';
                        const amount = input.includes('by') ? input.match(/by (\d+)/)?.[1] || '10' : '10';
                        convertedCode = `if time_elapsed > ${seconds}:\n    # Time-based adjustment\n    throttle = throttle ${action} ${amount}`;
                    }
                    else {
                        convertedCode = `# Custom logic implementation\n# Original: ${logicInput}\n# Implement your custom logic here`;
                    }
                    
                    convertedCode += `\n    # Ensure throttle stays within 0-100 range\n    throttle = max(min(throttle, 100), 0)`;
                    
                    const newContent = editorContent + '\n\n' + convertedCode;
                    setEditorContent(newContent);
                    editorRef.current.setValue(newContent);
                    
                    setStatus('Logic converted to code');
                } catch (error) {
                    setStatus('Conversion error: ' + error.message);
                }
            };

            const selectChallenge = (challenge) => {
                setActiveTab('CHALLENGES');
                setStatus(`Challenge: ${challenge.title}`);
                
                const newContent = codeTemplates['CHALLENGES'] + `\n\n# Challenge: ${challenge.title}\n# ${challenge.description}`;
                setEditorContent(newContent);
                editorRef.current.setValue(newContent);
                
                setUserProgress(prev => ({
                    ...prev,
                    [challenge.id]: { ...prev[challenge.id], attempted: true }
                }));
                
                setIsSimulating(true);
            };

            const checkChallenge = (challenge) => {
                const criteria = challenge.criteria;
                setStatus('Evaluating...');
                
                setTimeout(() => {
                    const heightOk = Math.abs(height - criteria.height) <= 0.5;
                    const rollOk = Math.abs(angles[0]) <= criteria.rollMax;
                    const pitchOk = Math.abs(angles[1]) <= criteria.pitchMax;
                    
                    if (heightOk && rollOk && pitchOk) {
                        setStatus('Challenge completed!');
                        
                        setUserProgress(prev => ({
                            ...prev,
                            [challenge.id]: { completed: true, score: challenge.points }
                        }));
                        
                        setLeaderboard(prev => {
                            const newLeaderboard = prev.map(entry => 
                                entry.name === username 
                                    ? { ...entry, score: entry.score + challenge.points }
                                    : entry
                            ).sort((a, b) => b.score - a.score);
                            
                            return [...newLeaderboard];
                        });
                    } else {
                        setStatus('Challenge not completed');
                    }
                }, 1500);
            };

            return (
                <div className="interface-font p-4 max-w-[100vw]">
                    {showProfileModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
                            <div className="cyber-card p-6 w-96">
                                <h3 className="text-lg mb-4" style={{ color: '#00f0ff' }}>
                                    CREATE PROFILE
                                </h3>
                                <input
                                    type="text"
                                    className="w-full p-2 mb-4 bg-black text-cyan-300 border border-purple-500 rounded-md text-sm font-mono"
                                    placeholder="Enter username (max 15 chars)"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                />
                                <button
                                    onClick={handleCreateProfile}
                                    className="cyber-card w-full"
                                >
                                    CREATE
                                </button>
                            </div>
                        </div>
                    )}

                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
                            <div className="cyber-card p-6 w-96">
                                <h3 className="text-lg mb-4" style={{ color: '#00f0ff' }}>
                                    CONFIRM DELETION
                                </h3>
                                <p className="mb-4 text-sm">
                                    Are you sure you want to delete the selected profile(s)?
                                </p>
                                <div className="grid grid-cols-2 gap-2">
                                    <button
                                        onClick={confirmDelete}
                                        className="cyber-button"
                                    >
                                        YES
                                    </button>
                                    <button
                                        onClick={cancelDelete}
                                        className="delete-button"
                                    >
                                        NO
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-4">
                        <div>
                            <h1 className="text-2xl" style={{ color: '#00f0ff' }}>
                                AirM FATEH DRONE
                            </h1>
                            <h2 className="text-lg" style={{ color: '#ff3e7f' }}>
                                LOGIC PROGRAMMING INTERFACE
                            </h2>
                        </div>
                        <div className="flex items-center">
                            <div className={`w-3 h-3 rounded-full mr-2 ${status.includes('error') || status.includes('failed') ? 'bg-red-500' : 'bg-green-500'}`}></div>
                            <span className="text-sm">{status}</span>
                        </div>
                    </div>
                    
                    <div className="cyber-card p-4 mb-4">
                        <h3 className="text-lg mb-2" style={{ color: '#00f0ff' }}>
                            DRONE CONNECTION
                        </h3>
                        <div className="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label className="text-xs text-gray-400">IP Address</label>
                                <input
                                    type="text"
                                    className="input-field"
                                    value={droneConfig.ip}
                                    onChange={(e) => saveDroneConfig({ ...droneConfig, ip: e.target.value })}
                                    placeholder="192.168.4.1"
                                />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">Port</label>
                                <input
                                    type="number"
                                    className="input-field"
                                    value={droneConfig.port}
                                    onChange={(e) => saveDroneConfig({ ...droneConfig, port: e.target.value })}
                                    placeholder="8080"
                                />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">Wi-Fi SSID</label>
                                <input
                                    type="text"
                                    className="input-field"
                                    value={droneConfig.ssid}
                                    onChange={(e) => saveDroneConfig({ ...droneConfig, ssid: e.target.value })}
                                    placeholder="PicoW"
                                />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400">Wi-Fi Password</label>
                                <input
                                    type="password"
                                    className="input-field"
                                    value={droneConfig.password}
                                    onChange={(e) => saveDroneConfig({ ...droneConfig, password: e.target.value })}
                                    placeholder="pico1234"
                                />
                            </div>
                        </div>
                        <div className="flex justify-between items-center">
                            <button
                                onClick={testDroneConnection}
                                className="cyber-button"
                            >
                                TEST CONNECTION
                            </button>
                            <span className="text-sm" style={{ color: connectionStatus === 'Connected' ? '#00ff80' : '#ff3e7f' }}>
                                {connectionStatus}
                            </span>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 scrollable-container">
                        <div className="cyber-card p-4 dynamic-height flex flex-col">
                            <h3 className="text-lg mb-2" style={{ color: '#00f0ff' }}>
                                CODE EDITOR
                            </h3>
                            <div 
                                id="editor" 
                                className="editor-font flex-grow w-full border border-gray-700 rounded"
                                style={{ backgroundColor: '#0a0a1a' }}
                            ></div>
                            
                            <div className="mt-4">
                                <textarea
                                    className="w-full h-16 p-2 bg-black text-cyan-300 border border-purple-500 rounded-md text-xs font-mono mb-2"
                                    placeholder="Enter logic (e.g., 'If height > 10, reduce throttle by 10%')"
                                    value={logicInput}
                                    onChange={(e) => setLogicInput(e.target.value)}
                                />
                            </div>
                            
                            <div className="grid grid-cols-2 gap-2">
                                <button 
                                    onClick={buildCode}
                                    className="cyber-button"
                                    disabled={isDeploying}
                                >
                                    BUILD
                                </button>
                                <button 
                                    onClick={startSimulation}
                                    className="cyber-button"
                                    disabled={!buildOutput.includes('successful') || isDeploying}
                                >
                                    SIMULATE
                                </button>
                                <button 
                                    onClick={deployToDrone}
                                    className="cyber-button"
                                    disabled={isDeploying}
                                >
                                    {isDeploying ? 'DEPLOYING...' : 'DEPLOY'}
                                </button>
                                <button 
                                    onClick={convertLogic}
                                    className="cyber-button"
                                    disabled={isDeploying}
                                >
                                    CONVERT
                                </button>
                            </div>
                            
                            {isDeploying && (
                                <div className="mt-2">
                                    <div className="progress-bar">
                                        <div 
                                            className="progress-fill" 
                                            style={{ width: `${deployProgress}%` }}
                                        ></div>
                                        <span className="progress-text">
                                            {Math.round(deployProgress)}%
                                        </span>
                                    </div>
                                </div>
                            )}
                            
                            {buildOutput && (
                                <div className="mt-2 p-2 bg-black rounded text-xs font-mono text-green-400 overflow-auto max-h-20">
                                    {buildOutput}
                                </div>
                            )}
                        </div>
                        
                        <div className="cyber-card p-4 dynamic-height flex flex-col">
                            <h3 className="text-lg mb-2" style={{ color: '#00f0ff' }}>
                                {simulationError ? 'SIMULATION ERROR' : 'DRONE SIMULATION'}
                            </h3>
                            
                            {simulationError ? (
                                <div className="text-red-400 p-4 text-center flex-grow">
                                    {simulationError}
                                </div>
                            ) : (
                                <>
                                    <div 
                                        ref={containerRef} 
                                        className="hologram-container mb-4"
                                    ></div>
                                    
                                    <div className="grid grid-cols-3 gap-2 text-center mb-4">
                                        <div>
                                            <p className="text-xs text-gray-400">ROLL</p>
                                            <p style={{ color: '#00f0ff' }}>{angles[0].toFixed(1)}°</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-gray-400">PITCH</p>
                                            <p style={{ color: '#00f0ff' }}>{angles[1].toFixed(1)}°</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-gray-400">YAW</p>
                                            <p style={{ color: '#00f0ff' }}>{angles[2].toFixed(1)}°</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-gray-400">ALTITUDE</p>
                                            <p style={{ color: '#00f0ff' }}>{height.toFixed(1)}m</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-gray-400">MODE</p>
                                            <p style={{ color: '#00f0ff' }}>{activeTab}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-gray-400">STATUS</p>
                                            <p style={{ color: isSimulating ? '#00ff80' : '#ff3e7f' }}>
                                                {isSimulating ? 'ACTIVE' : 'STANDBY'}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-3 gap-2">
                                        <button 
                                            onClick={() => handleControl('Up')}
                                            className="cyber-button"
                                            disabled={isDeploying}
                                        >
                                            ↑ UP
                                        </button>
                                        <button 
                                            onClick={() => handleControl('Forward')}
                                            className="cyber-button"
                                            disabled={isDeploying}
                                        >
                                            ↗ FWD
                                        </button>
                                        <button 
                                            onClick={() => handleControl('Reset')}
                                            className="cyber-button"
                                            disabled={isDeploying}
                                        >
                                            ⟳ RESET
                                        </button>
                                        <button 
                                            onClick={() => handleControl('Left')}
                                            className="cyber-button"
                                            disabled={isDeploying}
                                        >
                                            ← LEFT
                                        </button>
                                        <button 
                                            onClick={() => handleControl('Down')}
                                            className="cyber-button"
                                            disabled={isDeploying}
                                        >
                                            ↓ DOWN
                                        </button>
                                        <button 
                                            onClick={() => handleControl('Right')}
                                            className="cyber-button"
                                            disabled={isDeploying}
                                        >
                                            → RIGHT
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                        
                        <div className="cyber-card p-4 dynamic-height flex flex-col">
                            <h3 className="text-lg mb-2" style={{ color: '#00f0ff' }}>
                                CONTROL MODULES
                            </h3>
                            
                            <div className="grid grid-cols-3 gap-2 mb-4">
                                <button 
                                    className={`cyber-button ${activeTab === 'FATEH-V1' ? 'tab-active' : ''}`}
                                    onClick={() => setActiveTab('FATEH-V1')}
                                    disabled={isDeploying}
                                >
                                    FATEH-V1
                                </button>
                                <button 
                                    className={`cyber-button ${activeTab === 'CUSTOM' ? 'tab-active' : ''}`}
                                    onClick={() => setActiveTab('CUSTOM')}
                                    disabled={isDeploying}
                                >
                                    CUSTOM
                                </button>
                                <button 
                                    className={`cyber-button ${activeTab === 'CHALLENGES' ? 'tab-active' : ''}`}
                                    onClick={() => setActiveTab('CHALLENGES')}
                                    disabled={isDeploying}
                                >
                                    CHALLENGES
                                </button>
                            </div>
                            
                            {activeTab === 'CHALLENGES' && (
                                <div className="mb-4 flex-grow overflow-y-auto">
                                    <h4 className="text-md mb-2" style={{ color: '#ff3e7f' }}>
                                        CHALLENGES
                                    </h4>
                                    <div className="space-y-2">
                                        {challenges.map(challenge => (
                                            <div key={challenge.id} className="cyber-card p-2">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h5 className="font-bold">{challenge.title}</h5>
                                                        <p className="text-xs text-gray-300">{challenge.description}</p>
                                                        <p className="text-xs" style={{ color: '#00f0ff' }}>
                                                            Reward: {challenge.points} CR
                                                        </p>
                                                    </div>
                                                    {userProgress[challenge.id]?.completed ? (
                                                        <span className="completed-badge">COMPLETED</span>
                                                    ) : (
                                                        <div className="flex gap-1">
                                                            <button 
                                                                className="cyber-button text-xs"
                                                                onClick={() => selectChallenge(challenge)}
                                                                disabled={isDeploying}
                                                            >
                                                                START
                                                            </button>
                                                            {userProgress[challenge.id]?.attempted && (
                                                                <button 
                                                                    className="cyber-button text-xs"
                                                                    onClick={() => checkChallenge(challenge)}
                                                                    disabled={isDeploying}
                                                                >
                                                                    CHECK
                                                                </button>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            <h4 className="text-md mb-2" style={{ color: '#ff3e7f' }}>
                                LEADERBOARD
                            </h4>
                            <div className="space-y-2 flex-grow">
                                {leaderboard.sort((a, b) => b.score - a.score).slice(0, 5).map((entry, index) => (
                                    <div key={entry.name} className="flex justify-between items-center">
                                        <label className="flex items-center">
                                            <input
                                                type="checkbox"
                                                checked={selectedProfiles.includes(entry.name)}
                                                onChange={() => handleCheckboxChange(entry.name)}
                                                disabled={entry.ip !== currentIp || isDeploying}
                                                className="mr-2"
                                            />
                                            <span>{index + 1}. {entry.name}</span>
                                        </label>
                                        <span style={{ color: '#00f0ff' }}>{entry.score} CR</span>
                                    </div>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-2 mt-4">
                                <button
                                    onClick={handleAddProfile}
                                    className="add-button"
                                    disabled={isDeploying}
                                >
                                    ADD PROFILE
                                </button>
                                <button
                                    onClick={handleDeleteProfile}
                                    className="delete-button"
                                    disabled={isDeploying}
                                >
                                    DELETE
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="cyber-card p-2 mt-4 text-center text-xs">
                        CONNECT TO DRONE WIFI BEFORE DEPLOYING | VERSION: FATEH 1.0
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
